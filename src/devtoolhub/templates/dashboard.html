{% if not partial %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DevToolHub</title>
    <script src="/static/htmx.min.js"></script>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
    <h1>DevToolHub</h1>
{% endif %}

    <div class="tools-list"
         hx-get="/partials/status"
         hx-trigger="every 10s"
         hx-swap="innerHTML">
        {% for tool in tools %}
        {% set st = statuses.get(tool.name) %}
        {% set status_class = st.status if st else "unknown" %}
        <div class="tool-card">
            {# Row 1: Name, description, action #}
            <div class="card-row card-row-top">
                <div class="tool-status">
                    <span class="status-dot {{ status_class }}"
                          title="{{ status_class | upper }}"></span>
                </div>
                <div class="tool-name" title="{{ tool.name }}">{{ tool.name }}</div>
                <div class="tool-desc" title="{{ tool.description }}">
                    {{ tool.description }}
                </div>
                <div class="tool-action">
                    {% if tool.url %}
                        <a href="{{ tool.url }}" target="_blank" rel="noopener" class="btn">Open</a>
                    {% endif %}
                    {% if tool.window_title %}
                        {% if st and st.status == "up" %}
                            <button class="btn btn-focus"
                                    hx-post="/api/focus/{{ tool.name | urlencode }}"
                                    hx-swap="none">
                                Focus
                            </button>
                        {% endif %}
                    {% endif %}
                    {% if tool.start_command and (not st or st.status != "up") %}
                        <button class="btn btn-start"
                                hx-post="/api/start/{{ tool.name | urlencode }}"
                                hx-swap="none">
                            Start
                        </button>
                    {% endif %}
                </div>
            </div>

            {# Row 2: Status details #}
            <div class="card-row card-row-bottom">
                <div class="tool-status"></div>
                <div class="tool-state-info">
                    {% if st and st.status == "up" %}
                        <span class="state-badge up">Running</span>
                    {% elif st and st.status == "down" %}
                        <span class="state-badge down">Offline</span>
                    {% else %}
                        <span class="state-badge unknown">Checking...</span>
                    {% endif %}

                    {% if st and st.status == "up" and st.latency_ms %}
                        <span class="state-latency">{{ st.latency_ms }}ms</span>
                    {% endif %}

                    {% if st and st.details %}
                        {% for key, val in st.details.items() %}
                        <span class="detail-tag">
                            <span class="detail-label">{{ key }}</span>
                            <span class="detail-value">{{ val }}</span>
                        </span>
                        {% endfor %}
                    {% endif %}
                </div>
            </div>
        </div>
        {% endfor %}
    </div>

{% if not partial %}
    <div class="hub-footer">
        Polling every 10s &middot; {{ tools | length }} tool{{ "s" if tools | length != 1 }} configured
    </div>

    <script>
    document.body.addEventListener("htmx:afterRequest", function(evt) {
        var path = evt.detail.pathInfo && evt.detail.pathInfo.requestPath;
        if (!path) return;
        if (path.startsWith("/api/focus/") || path.startsWith("/api/start/")) {
            // Find the button that triggered this and show brief feedback
            var btn = evt.detail.elt;
            if (!btn) return;
            var orig = btn.textContent;
            if (evt.detail.successful) {
                btn.textContent = path.startsWith("/api/focus/") ? "Focused!" : "Started!";
                btn.classList.add("btn-ok");
            } else {
                btn.textContent = "Failed";
                btn.classList.add("btn-err");
            }
            setTimeout(function() {
                btn.textContent = orig;
                btn.classList.remove("btn-ok", "btn-err");
            }, 2000);
        }
    });
    </script>
</body>
</html>
{% endif %}
